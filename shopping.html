<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Mise en Place ‚Äì Shopping List</title>
<style>
:root{--ink:#1a1a1a; --muted:#566; --accent:#234E70; --accent-2:#9EC5E5; --bg:#ffffff; --pill:#EFF6FB; --pill-border:#D7E6F3; --line:#D9E3EA; --stripe:#FAFCFE}
html{scroll-behavior: smooth;}
body{font-family:system-ui, Segoe UI, Roboto, Arial, sans-serif; margin:0; color:var(--ink); background:var(--bg)}
.wrap{max-width:960px; margin:0 auto; padding:18px}
header{position:sticky; top:0; z-index:10; background:#fff; border-bottom:2px solid var(--accent); box-shadow:0 2px 8px rgba(35,78,112,0.1)}
header h1{margin:0 0 8px 0; font-size:2rem; font-weight:700; letter-spacing:-0.02em; color:var(--accent); line-height:1.1}
.toolbar{display:flex; gap:8px; align-items:center; margin:8px 0 12px; flex-wrap:wrap}
.btn{display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; text-decoration:none; color:inherit; box-shadow:0 1px 0 rgba(0,0,0,0.04); cursor:pointer;}
.btn:hover{background:#f8fbff}
.pill{display:inline-block; font-size:14px; padding:6px 10px; border-radius:999px; background:var(--pill); border:1px solid var(--pill-border); color:var(--accent)}
h2:focus{outline:none;}
.box{border:1px solid var(--line); border-radius:12px; padding:14px; background:#fff; box-shadow:0 1px 0 rgba(0,0,0,0.04)}
.grid{display:grid; gap:12px}
.cols-2{grid-template-columns:repeat(2,1fr)}
table{border-collapse:collapse; width:100%}
th,td{border:1px solid var(--line); padding:8px 10px; vertical-align:top}
th{background:#F3F8FC; color:var(--accent)}
tbody tr:nth-child(even) td{background:var(--stripe)}
.kicker{font-size:18px; color:var(--accent); letter-spacing:.05em; text-transform:uppercase; font-weight:700; margin-bottom:4px}
.checklist td, .checklist li { padding-left: 6px; }
.checklist label { display: inline-flex; align-items: center; gap: 8px; width: 100%; cursor: pointer; }
.checklist input[type="checkbox"] { flex-shrink:0; width: 1.1em; height: 1.1em; accent-color: var(--accent); cursor: pointer; }
.checklist input[type="checkbox"]:checked + span { text-decoration: line-through; color: var(--muted); }
@media (hover: none) and (pointer: coarse) {
  .btn { padding: 12px 16px; font-size: 16px; }
  .checklist label { padding: 4px 0; }
  .checklist input[type="checkbox"] { width: 1.4em; height: 1.4em; }
}
@media print{ .no-print{display:none !important} body{background:#fff} header{position:static; box-shadow:none} }
.dropdown { position: relative; display: inline-block; }
.dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid var(--line); z-index: 1; }
.dropdown-content a { color: black; padding: 12px 16px; text-decoration: none; display: block; }
.dropdown-content a:hover { background-color: #f1f1f1 }
.dropdown:hover .dropdown-content { display: block; }
</style>
</head>
<body>
<header class="wrap no-print">
<div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
<div>
<div class="kicker">Mise en Place</div>
<h1 id="plan-title"></h1>
<div class="pill" id="plan-meta"></div>
</div>
<nav class="toolbar">
<a class="btn" href="index.html">üè† Home</a>
<a class="btn" href="shopping.html">üõí Shopping</a>
<a class="btn" href="prep.html">üî™ Sunday Prep</a>
<a class="btn" href="recipes.html">üìñ Recipes</a>
<div class="dropdown">
<button class="btn">üóìÔ∏è Select Week</button>
<div id="plan-selector-dropdown" class="dropdown-content"></div>
</div>
</nav>
</div>
</header>
<main class="wrap">
<section id="page-shopping" class="checklist">
<div id="shopping-lists-container"></div>
<div class="toolbar">
<button class="btn" onclick="window.print()">üñ®Ô∏è Print this page</button>
<button class="btn" id="reset-button">üîÑ Reset Checkboxes</button>
</div>
</section>
</main>

<script>
const dropdownContainer = document.getElementById('plan-selector-dropdown');

function populateDropdown(plans) {
    plans.forEach(plan => {
        const link = document.createElement('a');
        link.href = `?week=${plan.id}`;
        link.textContent = plan.name;
        dropdownContainer.appendChild(link);
    });
}

function updateNavLinks(selectedWeek) {
    const navLinks = document.querySelectorAll('nav a.btn');
    navLinks.forEach(link => {
        const absoluteUrl = new URL(link.getAttribute('href'), window.location.href);
        absoluteUrl.searchParams.set('week', selectedWeek);
        link.href = absoluteUrl.toString();
    });
}

function renderPageContent(planData) {
    const STATE_KEY_PREFIX = 'mealPlanState_';
    let activePlan;
    
    function getStorageKey(data) { return `${STATE_KEY_PREFIX}${data.title}`; }
    function saveState(data) { localStorage.setItem(getStorageKey(data), JSON.stringify(data)); }
    function loadState(defaultData) { const savedStateJSON = localStorage.getItem(getStorageKey(defaultData)); return savedStateJSON ? JSON.parse(savedStateJSON) : defaultData; }
    
    function setupToggleListeners() { 
        document.querySelector('main').addEventListener('change', (e) => { 
            if (e.target.type !== 'checkbox') return; 
            const el = e.target; 
            const type = el.dataset.type; 
            if (type === 'shop') { 
                const section = el.dataset.section; 
                const category = el.dataset.category; 
                const index = parseInt(el.dataset.index, 10); 
                activePlan.shopping[section].lists[category][index].checked = el.checked; 
                saveState(activePlan); 
            } 
        }); 
    }
    
    function renderShoppingList(data) {
        document.getElementById('plan-title').textContent = `Week of ${data.title}`;
        document.getElementById('plan-meta').textContent = data.meta;
        const shoppingContainer = document.getElementById('shopping-lists-container');
        shoppingContainer.innerHTML = Object.entries(data.shopping).map(([title, section]) => `<div class="box"><h2>${title}</h2><div class="grid ${section.cols > 1 ? 'cols-2' : ''}">${Object.entries(section.lists).map(([category, items]) => `<table><thead><tr><th>${category}</th></tr></thead><tbody>${items.map((item, index) => `<tr><td><label><input type="checkbox" data-type="shop" data-section="${title}" data-category="${category}" data-index="${index}" ${item.checked ? 'checked' : ''}><span>${item.text}</span></label></td></tr>`).join('')}</tbody></table>`).join('')}</div></div>`).join('');
    }
    
    activePlan = loadState(planData);
    renderShoppingList(activePlan);
    setupToggleListeners();
    
    document.getElementById('reset-button').addEventListener('click', () => {
        if (confirm('Are you sure you want to reset all checkboxes for this week? This cannot be undone.')) {
            localStorage.removeItem(getStorageKey(activePlan));
            window.location.reload();
        }
    });
}

const manifestScript = document.createElement('script');
manifestScript.src = './plan-manifest.js';

manifestScript.onload = () => {
    populateDropdown(allPlans);
    const urlParams = new URLSearchParams(window.location.search);
    const weekId = urlParams.get('week');
    
    if (weekId) {
        updateNavLinks(weekId);
        const planScript = document.createElement('script');
        planScript.src = `./data/plan-${weekId}.js`;
        
        planScript.onload = () => {
            renderPageContent(planData);
        };
        document.head.appendChild(planScript);
    } else {
        document.querySelector('main').innerHTML = '<h1>Please select a week from the dropdown to begin.</h1>';
    }
};
document.head.appendChild(manifestScript);
</script>
</body>
</html>